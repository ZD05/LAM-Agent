# DeepSeek 智能命令处理与联网搜索功能

## 功能概述

LAM-Agent 现在集成了 DeepSeek AI 来智能处理用户输入，能够：
1. **智能分类**：区分问答类问题和操作类指令
2. **联网搜索**：对问答类问题进行实时网络搜索并生成回答
3. **命令拆分**：将操作类指令分解为多个可执行的步骤
4. **逐条执行**：按步骤顺序执行操作指令

## 工作流程

### 1. 智能分类
用户输入后，系统首先判断是问答类还是操作类：

**问答类示例**：
```
用户: "什么是人工智能？"
系统: "识别为问答类问题，正在联网搜索..."
```

**操作类示例**：
```
用户: "打开B站搜索影视飓风"
系统: "识别为操作类指令，正在使用DeepSeek分析..."
```

### 2. 问答类处理流程

#### 2.1 生成搜索关键词
DeepSeek 分析问题并生成搜索关键词：
```
问题: "什么是人工智能？"
关键词: ["人工智能定义", "AI是什么", "人工智能技术", "机器学习", "深度学习"]
```

#### 2.2 执行网络搜索
使用关键词进行网络搜索：
```
系统: "搜索关键词: 人工智能定义, AI是什么, 人工智能技术, 机器学习, 深度学习"
系统: "找到 5 条相关信息"
```

#### 2.3 生成智能回答
基于搜索结果生成回答：
```
AI助手: "人工智能（AI）是指让机器模拟人类智能的技术..."
```

### 3. 操作类处理流程

#### 3.1 命令拆分
DeepSeek 将复杂指令拆分为具体步骤：
```json
[
    {
        "action": "open_website",
        "params": {"url": "https://www.bilibili.com"},
        "description": "打开B站网站"
    },
    {
        "action": "bilibili_search",
        "params": {"keyword": "影视飓风"},
        "description": "在B站搜索影视飓风"
    }
]
```

#### 3.2 逐条执行
系统按照步骤顺序执行：
```
系统: "执行步骤 1: 打开B站网站"
系统: "步骤执行成功: 打开网站: https://www.bilibili.com"
系统: "执行步骤 2: 在B站搜索影视飓风"
系统: "步骤执行成功: B站搜索: 影视飓风"
```

## 支持的操作类型

### 网站操作
- `open_website`: 打开网站
- `bilibili_search`: B站搜索
- `web_search`: 网络搜索

### 页面自动化
- `click_element`: 点击页面元素
- `automate_page`: 页面自动化操作
- `play_video`: 播放视频

### 系统操作
- `desktop_scan`: 桌面扫描
- `run_command`: 执行系统命令

## 配置要求

### DeepSeek API 配置
确保在 `main.py` 中正确配置了 DeepSeek API：

```python
os.environ['DEEPSEEK_API_KEY'] = 'your-api-key'
os.environ['DEEPSEEK_BASE_URL'] = 'https://api.deepseek.com'
os.environ['LAM_AGENT_MODEL'] = 'deepseek-chat'
os.environ['USE_DEEPSEEK'] = 'true'
```

### 依赖包
确保安装了必要的依赖：
```bash
pip install langchain-openai
pip install langchain-core
```

## 使用示例

### 示例 1: 问答类问题
**输入**: "什么是人工智能？"

**处理流程**:
1. 系统识别为问答类问题
2. 生成搜索关键词: ["人工智能定义", "AI是什么", "人工智能技术"]
3. 执行网络搜索获取相关信息
4. 基于搜索结果生成智能回答

### 示例 2: 操作类指令
**输入**: "打开B站搜索影视飓风，进入主页，播放最新一期视频"

**处理流程**:
1. 系统识别为操作类指令
2. DeepSeek拆分为具体步骤
3. 逐条执行每个步骤
4. 显示执行状态和结果

### 示例 3: 混合场景
**输入**: "今天天气怎么样？然后打开天气网站"

**处理流程**:
1. 第一部分识别为问答类，进行联网搜索回答
2. 第二部分识别为操作类，执行打开网站操作

## 错误处理

### 常见错误类型
1. **DeepSeek 连接失败**: 检查 API Key 和网络连接
2. **命令拆分失败**: DeepSeek 无法理解指令
3. **执行失败**: 某个步骤执行出错

### 错误处理机制
- 每个步骤都有独立的错误处理
- 失败步骤不会影响后续步骤执行
- 详细的错误信息显示给用户

## 技术实现

### 核心类和方法
- `ChatGPTUI.classify_message()`: 消息分类
- `ChatGPTUI.handle_question_with_web_search()`: 问答处理
- `ChatGPTUI.generate_search_keywords()`: 关键词生成
- `ChatGPTUI.perform_web_search()`: 网络搜索
- `ChatGPTUI.generate_answer_from_search()`: 回答生成
- `ChatGPTUI.execute_deepseek_commands()`: 命令执行
- `ChatGPTUI.split_commands_with_deepseek()`: 命令拆分
- `ChatGPTUI.execute_single_command()`: 单步执行
- `ChatGPTUI.show_progress_bar()`: 显示进度条
- `ChatGPTUI.update_progress()`: 更新进度
- `ChatGPTUI.hide_progress_bar()`: 隐藏进度条

### DeepSeek 提示词模板

#### 消息分类提示词
```python
prompt = f"""
请判断以下用户输入是问答类问题还是操作类指令。

用户输入: {message}

判断标准：
- 问答类：询问信息、知识、解释、建议等
- 操作类：要求执行具体操作、打开应用、搜索内容等

请只返回以下两个选项之一：
- "question" (问答类)
- "action" (操作类)
"""
```

#### 搜索关键词生成提示词
```python
prompt = f"""
请根据以下用户问题生成3-5个最相关的搜索关键词。

用户问题: {message}

要求：
1. 关键词应该简洁明了
2. 能够有效搜索到相关信息
3. 包含问题的核心概念
4. 使用中文关键词

请按照以下格式返回JSON数组：
["关键词1", "关键词2", "关键词3"]
"""
```

#### 命令拆分提示词
```python
prompt = f"""
请将以下用户指令拆分为具体的可执行步骤。

用户指令: {message}

请按照以下格式返回JSON数组，每个元素包含：
- "action": 操作类型
- "params": 参数字典  
- "description": 步骤描述

请只返回JSON数组，不要包含其他文字。
"""
```

## 优势特点

### 1. 智能化
- **智能分类**：自动区分问答和操作指令
- **关键词生成**：智能生成搜索关键词
- **命令拆分**：将复杂指令分解为可执行步骤
- **自然语言理解**：支持自然语言描述

### 2. 实时性
- **联网搜索**：获取最新信息
- **实时回答**：基于搜索结果生成回答
- **动态执行**：实时显示执行进度

### 3. 可视化
- **分类显示**：清晰显示指令类型
- **进度跟踪**：实时显示执行进度和进度条
- **状态反馈**：每个步骤都有状态反馈
- **详细日志**：完整的执行记录
- **UI优化**：ChatGPT风格的现代化界面
- **执行状态**：实时显示当前执行状态

### 4. 可靠性
- **独立处理**：问答和操作独立处理
- **错误隔离**：步骤间互不影响
- **降级机制**：AI失败时的关键词降级
- **完整记录**：详细的执行和错误日志

### 5. 扩展性
- **模块化设计**：易于添加新功能
- **可配置性**：支持自定义提示词
- **API集成**：易于集成新的搜索API
- **多语言支持**：支持中英文处理

## 注意事项

1. **API 限制**: 注意 DeepSeek API 的调用频率限制
2. **网络依赖**: 需要稳定的网络连接进行搜索
3. **分类准确性**: 复杂指令可能需要人工确认分类
4. **搜索质量**: 搜索结果质量影响回答准确性
5. **执行时间**: 复杂指令可能需要较长时间执行
6. **错误恢复**: 某些步骤失败时，用户需要手动处理

## 测试结果

### 消息分类测试
```
消息: "什么是人工智能？" → 分类: 问答类
消息: "打开B站搜索影视飓风" → 分类: 操作类
消息: "今天天气怎么样？" → 分类: 问答类
消息: "点击登录按钮" → 分类: 操作类
```

### 关键词生成测试
```
问题: "什么是人工智能？"
关键词: ["人工智能定义", "AI是什么", "人工智能技术", "机器学习", "深度学习"]

问题: "今天天气怎么样？"
关键词: ["今天天气", "天气预报", "实时天气", "天气查询"]
```

### 命令拆分测试
```
输入: "打开B站搜索影视飓风，进入主页，播放最新一期视频"

拆分结果:
步骤 1: 打开B站网站 (action: open_website)
步骤 2: 在B站搜索影视飓风 (action: bilibili_search)
步骤 3: 进入影视飓风主页 (action: bilibili_open_up)
步骤 4: 播放最新一期视频 (action: bilibili_play_latest)

✓ 成功识别播放最新视频步骤
```

## 未来改进

1. **更多搜索源**: 集成更多搜索引擎和API
2. **智能重试**: 失败步骤的自动重试机制
3. **并行执行**: 支持独立步骤的并行执行
4. **用户确认**: 重要步骤的用户确认机制
5. **上下文记忆**: 支持多轮对话上下文
6. **个性化**: 根据用户偏好调整回答风格
